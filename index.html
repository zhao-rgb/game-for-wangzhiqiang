<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç‹å¿—å¼º Â· å››åˆä¸€å°æ¸¸æˆï¼ˆè·‘é…· / å¼¹å¹• / æ‰“åœ°é¼  / å¦å…‹å¤§æˆ˜ï¼‰</title>
<style>
  :root{--pink:#e91e63;--pink2:#ff80ab;--ok:#69f0ae;--bad:#ef5350;}
  html,body{height:100%}
  body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC}
  h1,h2{color:var(--pink2);text-shadow:0 0 14px rgba(255,128,171,.55);margin:.6rem 0 .3rem}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:12px}
  .menu{position:relative;z-index:10;background:rgba(255,255,255,.06);border:2px solid var(--pink2);border-radius:16px;padding:14px 16px;max-width:900px}
  .btn{padding:10px 16px;border:0;border-radius:999px;background:linear-gradient(45deg,var(--pink),var(--pink2));color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .hidden{display:none!important}
  .card{background:rgba(255,255,255,.06);border:2px solid var(--pink2);border-radius:14px;padding:10px 14px;width:920px;max-width:94vw}
  canvas{background:#141414;border-radius:12px}
  .center{display:flex;justify-content:center;align-items:center}
  .badge{display:inline-block;margin-left:8px;padding:1px 8px;border-radius:999px;background:rgba(255,255,255,.12)}
</style>
</head>
<body>
<div class="wrap">
  <h1>ç‹å¿—å¼º Â· å››åˆä¸€å°æ¸¸æˆ</h1>
  <div class="menu" id="menu">
    <div style="opacity:.9;margin-bottom:8px">å…³å¡é¡ºåºï¼šè·‘é…· â†’ å¼¹å¹• â†’ æ‰“åœ°é¼  â†’ å¦å…‹å¤§æˆ˜ï¼ˆ3 ä¸ªæ•Œäººï¼‰</div>
    <div class="center" style="gap:12px;flex-wrap:wrap">
      <button class="btn" id="startBtn">å¼€å§‹æŒ‘æˆ˜</button>
    </div>
  </div>

  <!-- stage1 è·‘é…· -->
  <section id="s1" class="card hidden">
    <h2>ç¬¬ä¸€å…³ï¼šé«˜éš¾è·‘é…·ï¼ˆRage Runï¼‰</h2>
    <div style="opacity:.85">ç©ºæ ¼/ç‚¹å‡»=è·³è·ƒï¼›å®Œæˆç›®æ ‡è·ç¦»å³è¿‡å…³<span class="badge" id="runHud"></span></div>
    <div class="center"><canvas id="run" width="760" height="230"></canvas></div>
    <div class="center" style="margin-top:8px"><button id="r1" class="btn">é‡è¯•æœ¬å…³</button></div>
  </section>

  <!-- stage2 å¼¹å¹• -->
  <section id="s2" class="card hidden">
    <h2>ç¬¬äºŒå…³ï¼šæé™å¼¹å¹•ï¼ˆBullet Hellï¼‰</h2>
    <div style="opacity:.85">WASD/æ–¹å‘é”®ç§»åŠ¨ï¼›åšæŒè§„å®šæ—¶é—´ä¸è¢«å‘½ä¸­ï¼ˆéšæœºå¼¹å¹•ï¼‰<span class="badge" id="hellHud"></span></div>
    <div class="center"><canvas id="hell" width="560" height="420"></canvas></div>
    <div class="center" style="margin-top:8px"><button id="r2" class="btn hidden">é‡è¯•æœ¬å…³</button></div>
  </section>

  <!-- stage3 æ‰“åœ°é¼  -->
  <section id="s3" class="card hidden">
    <h2>ç¬¬ä¸‰å…³ï¼šç»å…¸æ‰“åœ°é¼ </h2>
    <div class="center" style="gap:10px;flex-direction:column">
      <div id="moleHud" style="opacity:.85"></div>
      <div id="moleGrid" style="display:grid;grid-template-columns:repeat(4,100px);grid-gap:10px;"></div>
    </div>
    <div class="center" style="margin-top:8px"><button id="r3" class="btn hidden">é‡è¯•æœ¬å…³</button></div>
  </section>

  <!-- stage4 å¦å…‹å¤§æˆ˜ -->
  <section id="s4" class="card hidden">
    <h2>ç¬¬å››å…³ï¼šå¦å…‹å¤§æˆ˜ <span class="badge">WASD/æ–¹å‘é”®ç§»åŠ¨ Â· ç©ºæ ¼å¼€ç« Â· å‡»æ¯å…¨éƒ¨ 3 æ•Œäºº</span></h2>
    <div class="center"><canvas id="tank" width="720" height="420"></canvas></div>
    <div class="center" style="margin-top:8px"><button id="r4" class="btn">é‡è¯•æœ¬å…³</button></div>
  </section>

  <section id="final" class="card hidden">
    <h2>å…¨éƒ¨é€šå…³ï¼</h2>
    <div id="taunt" style="font-size:22px;margin:8px 0 12px">ç‹å¿—å¼ºï¼Œç®—ä½ è¡Œ ğŸ˜</div>
    <div class="center" style="gap:8px">
      <button id="again" class="btn">å†æ¥ä¸€æŠŠ</button>
    </div>
  </section>
</div>

<script>
/* ======= å·¥å…·ä¸åˆ‡æ¢ ======= */
function go(id){ ['menu','s1','s2','s3','s4','final'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
document.getElementById('startBtn').onclick=()=>{ go('s1'); startRun(); };

/* ======= ç¬¬ä¸€å…³ è·‘é…· ======= */
let runAnim=0;
function startRun(){
  const c=document.getElementById('run'), ctx=c.getContext('2d'), hud=document.getElementById('runHud');
  cancelAnimationFrame(runAnim); const floor=c.height-28;
  const player={x:70,y:floor-18,w:16,h:18,vy:0,on:true};
  const cfg={target:740,speed:3.1,gap:[140,190],jumpV:-9.2};
  const obs=[]; let lastX=0,dist=0; hud.textContent='ç›®æ ‡è·ç¦»ï¼š'+cfg.target;
  function addObs(){ lastX+=cfg.gap[0]+Math.random()*(cfg.gap[1]-cfg.gap[0]); obs.push({x:lastX,y:floor-18,w:18,h:18}); }
  for(let i=0;i<9;i++) addObs();
  function jump(){ if(player.on){ player.vy=cfg.jumpV; player.on=false; } }
  c.onclick=jump; window.onkeydown=(e)=>{ if(e.code==='Space'){ e.preventDefault(); jump(); } };

  function step(){
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle='#222'; ctx.fillRect(0,floor,c.width,2);
    player.vy+=0.45; player.y+=player.vy;
    if(player.y>=floor-18){ player.y=floor-18; player.vy=0; player.on=true; }
    ctx.fillStyle='#ffd54f'; ctx.fillRect(player.x,player.y,player.w,player.h);
    obs.forEach(o=>o.x-=cfg.speed);
    if(obs[0].x<-40){ obs.shift(); addObs(); }
    ctx.fillStyle='#ff80ab'; obs.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));
    for(const o of obs){ if(player.x<o.x+o.w && player.x+player.w>o.x && player.y<o.y+o.h && player.y+player.h>o.y){ cancelAnimationFrame(runAnim); document.getElementById('r1').onclick=startRun; return; } }
    dist+=cfg.speed; ctx.fillStyle='#fff'; ctx.fillText('è·ç¦»: '+Math.floor(dist), 10,16);
    if(dist>=cfg.target){ cancelAnimationFrame(runAnim); go('s2'); startHell(); return; }
    runAnim=requestAnimationFrame(step);
  }
  step();
}
document.getElementById('r1').onclick=startRun;

/* ======= ç¬¬äºŒå…³ å¼¹å¹•ï¼ˆç¨³å®š rAF + é™æµï¼‰ ======= */
let hellAnim=0;
function startHell(){
  const c=document.getElementById('hell'), ctx=c.getContext('2d'), hud=document.getElementById('hellHud');
  cancelAnimationFrame(hellAnim); document.getElementById('r2').classList.add('hidden');
  const P={x:c.width*0.5,y:c.height*0.8,r:7}; const bullets=[];
  const V=1.7, MAX=150, spawnPerS=28; let leftMs=9000; hud.textContent='åšæŒ 9s';
  const keys={}; const onKD=(e)=>{ keys[e.key]=true; if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' ','Space','Spacebar'].includes(e.key)) e.preventDefault(); }; const onKU=(e)=>{ keys[e.key]=false; };
  window.addEventListener('keydown',onKD,{passive:false}); window.addEventListener('keyup',onKU);
  let last=performance.now(), quota=0;
  function spawnEdge(){ if(bullets.length>=MAX) return; const s=Math.floor(Math.random()*4); let x=0,y=0,vx=0,vy=0,sp=V*0.9;
    if(s===0){x=0;y=Math.random()*c.height;vx=sp;vy=(Math.random()-.5)*sp*0.6;}
    if(s===1){x=c.width;y=Math.random()*c.height;vx=-sp;vy=(Math.random()-.5)*sp*0.6;}
    if(s===2){y=0;x=Math.random()*c.width;vy=sp;vx=(Math.random()-.5)*sp*0.6;}
    if(s===3){y=c.height;x=Math.random()*c.width;vy=-sp;vx=(Math.random()-.5)*sp*0.6;}
    bullets.push({x,y,vx,vy});
  }
  function spawnRing(){ if(bullets.length>=MAX-10) return;
    const cx=Math.random()*c.width, cy=Math.random()*c.height, n=12, hole=0.45, off=Math.random()*Math.PI*2;
    for(let i=0;i<n;i++){const ang=i*(Math.PI*2/n)+off; const norm=((ang-off+Math.PI*2)%(Math.PI*2)); if(norm<hole||norm>(Math.PI*2-hole)) continue; bullets.push({x:cx,y:cy,vx:Math.cos(ang)*V,vy:Math.sin(ang)*V});}
  }
  function cleanup(){ cancelAnimationFrame(hellAnim); window.removeEventListener('keydown',onKD); window.removeEventListener('keyup',onKU); }
  function win(){ cleanup(); go('s3'); startMole(); }
  function fail(){ cleanup(); document.getElementById('r2').classList.remove('hidden'); }
  function step(now){
    const dt=Math.min(50, now-last); last=now; leftMs-=dt;
    quota += spawnPerS*dt/1000; while(quota>=1){ quota-=1; (Math.random()<0.65?spawnEdge:spawnRing)(); }
    let dx=(keys['ArrowRight']||keys['d']?1:0)-(keys['ArrowLeft']||keys['a']?1:0);
    let dy=(keys['ArrowDown']||keys['s']?1:0)-(keys['ArrowUp']||keys['w']?1:0); if(dx||dy){ const len=Math.hypot(dx,dy)||1; P.x+=dx/len*2.3; P.y+=dy/len*2.3; }
    P.x=Math.max(8,Math.min(c.width-8,P.x)); P.y=Math.max(8,Math.min(c.height-8,P.y));
    for(const b of bullets){ b.x+=b.vx; b.y+=b.vy; }
    for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; if(b.x<-20||b.y<-20||b.x>c.width+20||b.y>c.height+20){ bullets.splice(i,1); continue; } if(Math.hypot(b.x-P.x,b.y-P.y)<P.r+2){ fail(); return; } }
    ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#fff'; ctx.fillText('å‰©ä½™: '+Math.ceil(leftMs/1000)+'s',10,16); ctx.fillStyle='#ff80ab'; bullets.forEach(b=>ctx.fillRect(b.x-2,b.y-2,4,4));
    ctx.fillStyle='#4caf50'; ctx.beginPath(); ctx.arc(P.x,P.y,P.r,0,Math.PI*2); ctx.fill(); if(leftMs<=0){ win(); return; } hellAnim=requestAnimationFrame(step);
  }
  hellAnim=requestAnimationFrame(step);
}
document.getElementById('r2').onclick=startHell;

/* ======= ç¬¬ä¸‰å…³ æ‰“åœ°é¼  ======= */
let moleTimer=0, moleAlive=false;
function startMole(){
  const grid=document.getElementById('moleGrid'), hud=document.getElementById('moleHud'); grid.innerHTML=''; hud.textContent='';
  const N=16; for(let i=0;i<N;i++){ const b=document.createElement('button'); b.textContent=''; b.style.width='100px'; b.style.height='100px'; b.style.borderRadius='10px'; b.style.border='0'; b.style.background='#222'; grid.appendChild(b); }
  const cells=[...grid.children]; let score=0, need=12, time=25;
  function spawn(){ if(!moleAlive) return; const i=Math.floor(Math.random()*N), el=cells[i]; if(el.textContent) return; el.textContent='ğŸ¹'; el.onclick=()=>{ score++; el.textContent=''; el.onclick=null; };
    setTimeout(()=>{ if(el.textContent){ el.textContent=''; el.onclick=null; } }, 600+Math.random()*400); }
  function tick(){ hud.innerHTML=`åˆ†æ•°ï¼š<b>${score}/${need}</b>ã€€æ—¶é—´ï¼š<b>${time}s</b>`; if(--time<0){ finish(); } }
  function finish(){ moleAlive=false; clearInterval(moleTimer); clearInterval(ti); if(score>=need){ go('s4'); startTank(); } else { document.getElementById('r3').classList.remove('hidden'); } }
  moleAlive=true; moleTimer=setInterval(spawn, 600); const ti=setInterval(tick,1000); tick();
  document.getElementById('r3').onclick=()=>{ clearInterval(moleTimer); clearInterval(ti); startMole(); };
}

/* ======= ç¬¬å››å…³ å¦å…‹å¤§æˆ˜ï¼ˆ3 æ•Œäºº Â· è¿·å®« + BFS + é“å…·ï¼‰ ======= */
let tankAnim=0;
function startTank(){
  const c=document.getElementById('tank'), ctx=c.getContext('2d'); cancelAnimationFrame(tankAnim);
  const TS=20, COLS=Math.floor(c.width/TS), ROWS=Math.floor(c.height/TS);
  const T0=0, TW=1, TC=2; // ç©ºåœ°/å¢™/æœ¨ç®±
  const map=Array.from({length:ROWS},()=>Array(COLS).fill(TW)); // åˆå§‹åŒ–ä¸ºå¢™ï¼ŒéšåæŒ–è¿·å®«
  const crateHP={};

  // ç”Ÿæˆè¿·å®«ï¼ˆé€’å½’å›æº¯ï¼Œå¥‡æ•°ç½‘æ ¼ä¸ºè·¯ï¼‰
  const MR=ROWS|1, MC=COLS|1;
  function carve(x,y){
    map[y][x]=T0;
    const dirs=[[2,0],[0,2],[-2,0],[0,-2]].sort(()=>Math.random()-.5);
    for(const [dx,dy] of dirs){
      const nx=x+dx, ny=y+dy;
      if(nx>0 && nx<MC-1 && ny>0 && ny<MR-1 && map[ny][nx]===TW){
        map[y+dy/2][x+dx/2]=T0; carve(nx,ny);
      }
    }
  }
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) map[y][x]=TW;
  carve(1,1);
  // éšæœºæ”¾ä¸€äº›æœ¨ç®±ï¼ˆä¸å µæ­»ä¸»å¹²ï¼‰
  for(let t=0;t<24;t++){ const r=2+Math.floor(Math.random()*(ROWS-4)), k=2+Math.floor(Math.random()*(COLS-4)); if(map[r][k]===T0 && Math.random()<0.7){ map[r][k]=TC; crateHP[r+','+k]=(Math.random()<0.4?2:1); } }
  // è¾¹æ¡†ç•™å¢™
  for(let r=0;r<ROWS;r++){ map[r][0]=map[r][COLS-1]=TW; } for(let k=0;k<COLS;k++){ map[0][k]=map[ROWS-1][k]=TW; }

  function get(r,k){ return (r<0||k<0||r>=ROWS||k>=COLS)?TW:map[r][k]; }
  function set(r,k,v){ if(r>=0&&k>=0&&r<ROWS&&k<COLS){ map[r][k]=v; if(v!==TC) delete crateHP[r+','+k]; } }
  function w2c(x,y){ return [Math.floor(y/TS),Math.floor(x/TS)]; }
  function c2w(r,k){ return {x:k*TS+TS/2,y:r*TS+TS/2}; }
  function solidRect(x,y,w,h){ const pts=[[x,y],[x+w,y],[x,y+h],[x+w,y+h]]; for(const [px,py] of pts){ const [r,k]=w2c(px,py), t=get(r,k); if(t===TW||t===TC) return true; } return false; }

  function Tank(x,y,enemy=false){ return {x,y,dir:0,speed:2.4,enemy,cd:0,stuck:0,path:null,hp:enemy?1:3,inv:0}; }
  function free(){ // æ‰¾ä¸€ä¸ªå¯è¾¾ç©ºåœ°
    for(let tries=0; tries<400; tries++){ const r=1+Math.floor(Math.random()*(ROWS-2)), k=1+Math.floor(Math.random()*(COLS-2)); if(get(r,k)===T0) { const p=c2w(r,k); return {x:p.x,y:p.y}; } }
    return {x:60,y:60};
  }

  const p0=free(); const player=Tank(p0.x,p0.y,false);
  const enemies=[]; for(let i=0;i<3;i++){ const s=free(); enemies.push(Tank(s.x,s.y,true)); }
  const bullets=[]; let power={shield:0, triple:0, rapid:0};

  function fire(t){ if(t.cd>0) return; const a=t.dir, sp=4.7; const add=(vx,vy)=>bullets.push({x:t.x,y:t.y,vx,vy,fromEnemy:t.enemy,life:260});
    const spread=t.enemy?0.08:0.05; const base=[a, a+(Math.random()*spread-spread/2)];
    if(!t.enemy && power.triple>0){ base.push(a+0.18,a-0.18); }
    base.forEach(ang=>add(Math.cos(ang)*sp,Math.sin(ang)*sp));
    t.cd = t.enemy ? 38 : (power.rapid>0 ? 10 : 16);
  }

  function move(t,dx,dy){ const sp=t.speed; let nx=t.x+dx*sp, ny=t.y; if(!solidRect(nx-12,ny-9,24,18)) t.x=nx; nx=t.x; ny=t.y+dy*sp; if(!solidRect(nx-12,ny-9,24,18)) t.y=ny; t.x=Math.max(12,Math.min(t.x,c.width-12)); t.y=Math.max(9,Math.min(t.y,c.height-9)); }
  function los(ax,ay,bx,by){ const steps=24; for(let i=1;i<=steps;i++){ const x=ax+(bx-ax)*i/steps,y=ay+(by-ay)*i/steps; const [r,k]=w2c(x,y), t=get(r,k); if(t===TW||t===TC) return false; } return true; }

  // BFS è·¯å¾„
  function bfs(fr,fk,tr,tk){
    const key=(r,k)=>r+','+k; const q=[[fr,fk]], prev=new Map(), seen=new Set([key(fr,fk)]);
    const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
    while(q.length){ const [r,k]=q.shift(); if(r===tr&&k===tk) break;
      for(const [dr,dk] of dirs){ const nr=r+dr,nk=k+dk,kk=key(nr,nk);
        if(nr<0||nk<0||nr>=ROWS||nk>=COLS) continue; if(get(nr,nk)!==T0) continue;
        if(!seen.has(kk)){ seen.add(kk); prev.set(kk,[r,k]); q.push([nr,nk]); }
      }
    }
    let cur=[tr,tk], kk=key(cur[0],cur[1]); if(!prev.has(kk)) return null;
    while(prev.get(kk) && prev.get(kk)[0]!==fr || prev.get(kk)[1]!==fk){ const p=prev.get(kk); if(!p) break; cur=p; kk=key(cur[0],cur[1]); if(cur[0]===fr && cur[1]===fk) break; }
    return cur;
  }

  // æ‰è½é“å…·
  function dropPower(x,y){
    const type = Math.random()<0.34?'shield':(Math.random()<0.5?'triple':'rapid');
    return {x,y,type,life:600};
  }
  const drops=[];

  // æ§åˆ¶
  const keys={};
  const onKD=(e)=>{ keys[e.key]=true; if([' ','Spacebar','Space','ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) e.preventDefault(); };
  const onKU=(e)=>{ keys[e.key]=false; };
  document.addEventListener('keydown',onKD,{passive:false});
  document.addEventListener('keyup',onKU);

  function over(win){
    cancelAnimationFrame(tankAnim);
    document.removeEventListener('keydown',onKD); document.removeEventListener('keyup',onKU);
    if(win){ go('final'); }
    else { document.getElementById('r4').onclick=startTank; }
  }

  function update(){
    // ç©å®¶ç§»åŠ¨ä¸å¼€ç«
    let dx=(keys['ArrowRight']||keys['d']?1:0)-(keys['ArrowLeft']||keys['a']?1:0);
    let dy=(keys['ArrowDown']||keys['s']?1:0)-(keys['ArrowUp']||keys['w']?1:0);
    if(dx||dy){ const len=Math.hypot(dx,dy)||1; move(player,dx/len,dy/len); player.dir=Math.atan2(dy,dx); }
    if(keys[' ']||keys['Spacebar']||keys['Space']) fire(player);
    if(player.cd>0) player.cd--; if(player.inv>0) player.inv--;

    // æ•Œäºº AI
    enemies.forEach(e=>{
      const [pr,pk]=w2c(player.x,player.y), [er,ek]=w2c(e.x,e.y);
      if(!e.path || e.stuck>25 || Math.random()<0.02){ const n=bfs(er,ek,pr,pk); e.path=n?[n[0],n[1]]:null; e.stuck=0; }
      let mx=0,my=0;
      if(e.path){ const t=c2w(e.path[0],e.path[1]); const vx=t.x-e.x,vy=t.y-e.y,len=Math.hypot(vx,vy)||1; mx=vx/len*e.speed*.9; my=vy/len*e.speed*.9; if(Math.hypot(vx,vy)<6) e.path=null; }
      else { mx=(Math.random()-.5)*e.speed; my=(Math.random()-.5)*e.speed; }
      const ox=e.x,oy=e.y; move(e,mx,my); if(Math.hypot(e.x-ox,e.y-oy)<.05) e.stuck++; else e.stuck=0;
      e.dir=Math.atan2(player.y-e.y,player.x-e.x);
      if(e.cd>0) e.cd--;
      if(los(e.x,e.y,player.x,player.y) && Math.random()<0.15) fire(e);
    });

    // å­å¼¹æ›´æ–°
    bullets.forEach(b=>{
      b.x+=b.vx; b.y+=b.vy; b.life--;
      const [r,k]=w2c(b.x,b.y); const t=get(r,k);
      if(t===TW){ b.life=0; }
      else if(t===TC){ b.life=0; const id=r+','+k; crateHP[id]=(crateHP[id]||1)-1; if(crateHP[id]<=0){ set(r,k,T0); if(Math.random()<0.45) drops.push(dropPower(k*TS+10,r*TS+10)); } }
    });
    // å­å¼¹å‘½ä¸­
    for(const b of bullets){
      if(b.life<=0) continue;
      if(!b.fromEnemy){
        enemies.forEach(e=>{ if(e.hp>0 && Math.hypot(e.x-b.x,e.y-b.y)<13){ e.hp=0; b.life=0; } });
      }else{
        if(Math.hypot(player.x-b.x,player.y-b.y)<13){
          if(player.inv>0) { b.life=0; } else if(power.shield>0){ power.shield-=60; b.life=0; if(power.shield<=0) player.inv=40; }
          else{ b.life=0; player.hp--; player.inv=50; if(player.hp<=0){ over(false); return; } }
        }
      }
    }
    // æ¸…ç†
    for(let i=bullets.length-1;i>=0;i--) if(bullets[i].life<=0) bullets.splice(i,1);
    for(let i=enemies.length-1;i>=0;i--) if(enemies[i].hp<=0) enemies.splice(i,1);
    if(enemies.length===0){ over(true); return; }

    // é“å…·æ‹¾å–/è¡°å‡
    for(let i=drops.length-1;i>=0;i--){
      const d=drops[i]; d.life--;
      if(Math.hypot(player.x-(d.x+0), player.y-(d.y+0))<16){
        if(d.type==='shield') power.shield=240; // 4s æŠ¤ç›¾
        if(d.type==='triple') power.triple=360;
        if(d.type==='rapid')  power.rapid =360;
        drops.splice(i,1);
      }else if(d.life<=0){ drops.splice(i,1); }
    }
    if(power.triple>0) power.triple--; if(power.rapid>0) power.rapid--; if(power.shield>0) power.shield--;

    // ç»˜åˆ¶
    ctx.clearRect(0,0,c.width,c.height);
    for(let r=0;r<ROWS;r++) for(let k=0;k<COLS;k++){ const t=map[r][k]; if(t===TW){ ctx.fillStyle='#1e1e1e'; ctx.fillRect(k*TS,r*TS,TS-1,TS-1); } if(t===TC){ ctx.fillStyle='#6d4c41'; ctx.fillRect(k*TS+2,r*TS+2,TS-4,TS-4); } }
    // HUD
    ctx.fillStyle='#fff'; ctx.fillText('ç”Ÿå‘½ï¼š'+player.hp+'   æ•Œäººå‰©ä½™ï¼š'+enemies.length,8,14);
    if(power.shield>0) ctx.fillText('æŠ¤ç›¾',160,14);
    if(power.triple>0) ctx.fillText('ä¸‰è¿',200,14);
    if(power.rapid>0)  ctx.fillText('æ€¥å°„',240,14);
    // å­å¼¹
    ctx.fillStyle='#fff'; bullets.forEach(b=>ctx.fillRect(b.x-2,b.y-2,4,4));
    // æ•Œäºº
    enemies.forEach(e=>{ ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.dir); ctx.fillStyle='#e57373'; ctx.fillRect(-12,-9,24,18); ctx.fillStyle='#ffcdd2'; ctx.fillRect(0,-3,16,6); ctx.restore(); });
    // ç©å®¶
    ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.dir); ctx.fillStyle='#64b5f6'; ctx.fillRect(-12,-9,24,18); ctx.fillStyle='#bbdefb'; ctx.fillRect(0,-3,16,6); ctx.restore();
    if(power.shield>0||player.inv>0){ ctx.fillStyle='rgba(76,175,80,0.35)'; ctx.beginPath(); ctx.arc(player.x,player.y,16,0,Math.PI*2); ctx.fill(); }

    tankAnim=requestAnimationFrame(update);
  }

  document.getElementById('r4').onclick=()=>{ cancelAnimationFrame(tankAnim); startTank(); };
  update();
}

document.getElementById('again').onclick=()=>location.reload();
</script>
</body>
</html>
